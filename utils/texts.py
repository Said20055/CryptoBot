
from datetime import datetime, timedelta
import html

from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
from typing import List, Tuple

from .helpers import format_timedelta # <-- –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –Ω–æ–≤—ã–π —Ö–µ–ª–ø–µ—Ä




# --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é ---
WELCOME_PHOTO_URL = "AgACAgIAAxkBAAOCaMe8_YoQvR8VmQgxGrvwJ2Ew8bQAAqP4MRvD4zhKhf8sL6uWlyABAAMCAAN5AAM2BA"

WELCOME_TEXT = (
    "üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ExpressObmen P2P!</b>\n\n"
    "üí∏ <b>–û–±–º–µ–Ω –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∫–æ–º–∏—Å—Å–∏–π –∏ –∑–∞–¥–µ—Ä–∂–µ–∫!</b>\n"
    "‚ö°Ô∏è <b>–°–∞–º—ã–µ –Ω–∏–∑–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ –Ω–∞ —Ä—ã–Ω–∫–µ</b> ‚Äî –º—ã –∑–∞–±–æ—Ç–∏–º—Å—è –æ –≤–∞—à–µ–º –±—é–¥–∂–µ—Ç–µ!\n"
    "üîí <b>–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</b> –∏ –≥–∞—Ä–∞–Ω—Ç–∏—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.\n"
    "üöÄ <b>–ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ–±–º–µ–Ω—ã 24/7</b> –≤ –ø–∞—Ä—É –∫–ª–∏–∫–æ–≤.\n"
    "üì± <b>–£–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä—è–º–æ –≤ Telegram</b> ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É –∏ —Å—É–º–º—É!\n\n"
    "<b>–ù–∞—á–Ω–∏—Ç–µ –æ–±–º–µ–Ω –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</b> –∏ –æ—â—É—Ç–∏—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –≤—ã–≥–æ–¥—É —Å <b>ExpressObmen P2P!</b>\n\n"
)

HELP_TEXT = "–ø–∞–º–∞–≥–∏—Ç–µ"

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä ---



# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π ---

SELL_CRYPTO_TEXT = "<b>üßæ –ú–µ–Ω—é –ø—Ä–æ–¥–∞–∂–∏</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ –∏ —Å–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º."
BUY_CRYPTO_TEXT = "<b>üßæ –ú–µ–Ω—é –ø–æ–∫—É–ø–∫–∏</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –∏ —Å–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º."
OPERATOR_CONTACT_TEXT = "üë®‚Äçüíº <b>–°–≤—è–∑—å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º:</b> @jenya2hh\n\n–ù–∞–ø–∏—à–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–º–æ—â–∏ —Å –æ–±–º–µ–Ω–æ–º."
SEND_TX_LINK_PROMPT = "üìé <b>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –±–ª–æ–∫—á–µ–π–Ω–µ.</b>\n\n–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç –µ–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞—è–≤–∫—É."
REPLY_TO_OPERATOR_PROMPT = "üí¨ <b>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:</b>"






# ==========================================================
# ===== –ù–û–í–´–ï –¢–ï–ö–°–¢–´ –ò –ö–õ–ê–í–ò–ê–¢–£–†–´: –°–ò–°–¢–ï–ú–ê –õ–û–¢–ï–†–ï–ò =========
# ==========================================================

def get_lottery_menu_text(lottery_info: dict, can_get_ticket: bool) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –º–µ–Ω—é –ª–æ—Ç–µ—Ä–µ–∏."""
    last_play = lottery_info.get('last_play')
    
    header = "üé∞ <b>–õ–æ—Ç–µ—Ä–µ—è ExpressObmen P2P</b>\n\n"
    
    if can_get_ticket:
        ticket_text = "‚ú® –£ –≤–∞—Å –µ—Å—Ç—å <b>1</b> –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞! –ì–æ—Ç–æ–≤—ã –∏—Å–ø—ã—Ç–∞—Ç—å —É–¥–∞—á—É?"
    else:
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –±–∏–ª–µ—Ç–∞
        next_ticket_time = lottery_info.get('last_ticket') + timedelta(hours=24)
        time_left = next_ticket_time - datetime.now()
        formatted_time = format_timedelta(time_left)
        ticket_text = f"‚è≥ –°–ª–µ–¥—É—é—â–∞—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏–≥—Ä–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑: <b>{formatted_time}</b>"

    cooldown_text = ""
    if last_play:
        next_play_time = last_play + timedelta(hours=24)
        time_left = next_play_time - datetime.now()
        if time_left.total_seconds() > 0:
            formatted_time = format_timedelta(time_left)
            cooldown_text = f"\n\n(–í—ã —É–∂–µ –∏–≥—Ä–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è. –°–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑: <b>{formatted_time}</b>)"

    return f"{header}{ticket_text}{cooldown_text}"


def get_lottery_menu_keyboard(can_play: bool) -> InlineKeyboardMarkup:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –º–µ–Ω—é –ª–æ—Ç–µ—Ä–µ–∏.
    –ö–Ω–æ–ø–∫–∞ "–ò–≥—Ä–∞—Ç—å" –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å.
    """
    buttons = []
    
    if can_play:
        buttons.append(
            [InlineKeyboardButton(text="üé≤ –ò—Å–ø—ã—Ç–∞—Ç—å —É–¥–∞—á—É!", callback_data="lottery_play")]
        )
        
    buttons.append([InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_main_menu")])
    return InlineKeyboardMarkup(inline_keyboard=buttons)

def get_lottery_win_text(amount: float) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è —Å –≤—ã–∏–≥—Ä—ã—à–µ–º."""
    return (
        f"üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> üéâ\n\n"
        f"–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ <b>{amount:,.2f} RUB</b>!\n\n"
        f"–°—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞—á–∏—Å–ª–µ–Ω—ã –Ω–∞ –≤–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ –≤ —Ä–∞–∑–¥–µ–ª–µ "
        f"¬´üíé –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞¬ª."
    )




def format_user_display_name(username: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è."""
    if not username or username in ["–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", "–ù–µ—Ç username"]:
        return "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    
    if ' ' not in username and not username.startswith('@'):
        return f"@{username}"
    
    return username

def get_crypto_prompt_text(action: str, crypto: str, rate: float) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –≤–≤–µ—Å—Ç–∏ —Å—É–º–º—É –≤ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–µ."""
    if action == 'sell':
        action_text = f"<b>–ü—Ä–æ–¥–∞–∂–∞ {html.escape(crypto)}</b>"
        prompt_text = f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ <b>{html.escape(crypto)}</b>, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å."
    else:
        action_text = f"<b>–ü–æ–∫—É–ø–∫–∞ {html.escape(crypto)}</b>"
        prompt_text = f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ <b>{html.escape(crypto)}</b>, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å."

    formatted_rate = f"{rate:,.2f}".replace(",", " ")
    return (
        f"{action_text}\n\n"
        f"–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å: <code>1 {crypto} ‚âà {formatted_rate} RUB</code>\n\n"
        f"{prompt_text}"
    )

def get_rub_prompt_text(action: str, crypto: str, rate: float) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –≤–≤–µ—Å—Ç–∏ —Å—É–º–º—É –≤ —Ä—É–±–ª—è—Ö."""
    if action == 'sell':
        action_text = f"<b>–ü—Ä–æ–¥–∞–∂–∞ {html.escape(crypto)}</b>"
        prompt_text = f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ <b>RUB</b>, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å <b>{html.escape(crypto)}</b>."
    else:
        action_text = f"<b>–ü–æ–∫—É–ø–∫–∞ {html.escape(crypto)}</b>"
        prompt_text = f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ <b>RUB</b>, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å <b>{html.escape(crypto)}</b>."

    formatted_rate = f"{rate:,.2f}".replace(",", " ")
    return (
        f"{action_text}\n\n"
        f"–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å: <code>1 {crypto} ‚âà {formatted_rate} RUB</code>\n\n"
        f"{prompt_text}"
    )

def get_transaction_summary_text(
    action: str, crypto: str, amount_crypto: float, amount_rub: float,
    total_amount: float, service_commission_rub: float, network_fee_rub: float,
    promo_applied: bool, user_requisites: str # <-- –ù–û–í–´–ô –ü–ê–†–ê–ú–ï–¢–†
) -> str:
    """
    (–ò–ó–ú–ï–ù–ï–ù–û) –§–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å –ø–æ–ª–Ω—ã–º –æ–±–∑–æ—Ä–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –≤–∫–ª—é—á–∞—è —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    commission_info = "–ë–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏ ‚ú®" if promo_applied else f"{service_commission_rub:.0f} RUB"
    network_fee_info = "–ü–æ–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞–º–∏" if promo_applied else f"{network_fee_rub:.0f} RUB"
    
    if action == 'buy':
        requisites_title = "–í–∞—à –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è"
        total_line = f"<b>–ö –æ–ø–ª–∞—Ç–µ:</b> <code>{total_amount:.0f} RUB</code>"
    else: # sell
        requisites_title = "–í–∞—à–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è"
        total_line = f"<b>–ö –ø–æ–ª—É—á–µ–Ω–∏—é:</b> <code>{total_amount:.0f} RUB</code>"

    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    safe_user_requisites = html.escape(user_requisites)

    return (
        f"<b>üîç –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ:</b>\n\n"
        f"<b>–î–µ–π—Å—Ç–≤–∏–µ:</b> {'–ü–æ–∫—É–ø–∫–∞' if action == 'buy' else '–ü—Ä–æ–¥–∞–∂–∞'} {crypto.upper()}\n"
        f"<b>–°—É–º–º–∞ –≤ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–µ:</b> <code>{amount_crypto:.8f} {crypto.upper()}</code>\n"
        f"<b>–°—É–º–º–∞ –≤ —Ä—É–±–ª—è—Ö:</b> <code>{amount_rub:.0f} RUB</code>\n\n"
        f"<b>{requisites_title}:</b>\n"
        f"<code>{safe_user_requisites}</code>\n\n"
        f"<b>–ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ä–≤–∏—Å–∞:</b> {commission_info}\n"
        f"<b>–ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ç–∏:</b> {network_fee_info}\n\n"
        f"{total_line}\n\n"
        f"–ï—Å–ª–∏ –≤—Å–µ –≤–µ—Ä–Ω–æ, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ."
    )

def get_user_requisites_prompt_text(action: str, crypto: str) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å –ø—Ä–æ—Å—å–±–æ–π –≤–≤–µ—Å—Ç–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã.
    –¢–µ–∫—Å—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –ø–æ–∫—É–ø–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫—Ä–∏–ø—Ç—É –∏–ª–∏ –ø—Ä–æ–¥–∞–µ—Ç.
    """
    if action == 'buy':
        # –ï—Å–ª–∏ –ø–æ–∫—É–ø–∞–µ—Ç, –ø—Ä–æ—Å–∏–º –∞–¥—Ä–µ—Å –µ–≥–æ –∫–æ—à–µ–ª—å–∫–∞
        prompt = (
            f"‚úÖ <b>–û—Ç–ª–∏—á–Ω–æ!</b>\n\n"
            f"–¢–µ–ø–µ—Ä—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ <b>–∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ {crypto.upper()} –∫–æ—à–µ–ª—å–∫–∞</b>, "
            f"–Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –º—ã –æ—Ç–ø—Ä–∞–≤–∏–º –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∞—à–µ–π –æ–ø–ª–∞—Ç—ã."
        )
    else: # sell
        # –ï—Å–ª–∏ –ø—Ä–æ–¥–∞–µ—Ç, –ø—Ä–æ—Å–∏–º –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
        prompt = (
            "‚úÖ <b>–û—Ç–ª–∏—á–Ω–æ!</b>\n\n"
            "–¢–µ–ø–µ—Ä—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–∞—à–∏–º–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã. "
            "–ù–∞–ø—Ä–∏–º–µ—Ä:\n"
            "<code>–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á, –°–±–µ—Ä–±–∞–Ω–∫, 89991234567</code>"
        )
    return prompt


def get_admin_order_notification_for_topic(
    order_id: int,
    order_number: int,
    user_id: int,
    username: str,
    order_data: dict,
    user_input: str
) -> Tuple[str, InlineKeyboardMarkup]:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç HTML-—Ç–µ–∫—Å—Ç —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞—è–≤–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Ç–µ–º—É –≥—Ä—É–ø–ø—ã.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç (str) –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É (InlineKeyboardMarkup).
    """
    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è FSM
    action = order_data.get('action', 'N/A').title()
    crypto = order_data.get('crypto', 'N/A')

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Å–µ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
    amount_crypto_str = f"{order_data.get('amount_crypto', 0):,.8f}".rstrip('0').rstrip('.')
    amount_rub_str = f"{order_data.get('amount_rub', 0):,.0f}".replace(",", " ")
    service_commission_str = f"{order_data.get('service_commission_rub', 0):,.0f}".replace(",", " ")
    network_fee_str = f"{order_data.get('network_fee_rub', 0):,.0f}".replace(",", " ")
    total_amount_str = f"{int(order_data.get('total_amount', 0)):.0f}".replace(",", " ")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_details_title = "–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è RUB:" if order_data.get('action') == 'sell' else f"–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞ {crypto}:"

    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    safe_username = html.escape(username or "N/A")
    safe_user_input = html.escape(user_input or "N/A")

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞—è–≤–∫–∏
    details = [
        f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {safe_username} (<code>{user_id}</code>)",
        f"\n<b>–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏:</b>",
        f"  - <b>–¢–∏–ø:</b> {action} {crypto}",
        f"  - <b>–°—É–º–º–∞ –≤ –∫—Ä–∏–ø—Ç–µ:</b> <code>{amount_crypto_str} {crypto}</code>",
        f"  - <b>–≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –≤ RUB (—á–∏—Å—Ç—ã–º–∏):</b> <code>{amount_rub_str} RUB</code>",
        f"\n<b>–ö–æ–º–∏—Å—Å–∏–∏:</b>",
        f"  - <b>–°–µ—Ä–≤–∏—Å:</b> <code>{service_commission_str} RUB</code>",
        f"  - <b>–°–µ—Ç—å:</b> <code>{network_fee_str} RUB</code>",
        f"\n<b>–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞:</b> <code>{total_amount_str} RUB</code>",
        f"\n<b>{html.escape(user_details_title)}</b>",
        f"<code>{safe_user_input}</code>"
    ]

    # –ï—Å–ª–∏ –±—ã–ª –ø—Ä–∏–º–µ–Ω—ë–Ω –ø—Ä–æ–º–æ–∫–æ–¥, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–º–µ—Ç–Ω—É—é –ø–ª–∞—à–∫—É –≤ –Ω–∞—á–∞–ª–æ
    if order_data.get('promo_applied'):
        details.insert(1, "‚úÖ <b>–ò–°–ü–û–õ–¨–ó–û–í–ê–ù –ü–†–û–ú–û–ö–û–î</b>")

    # –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
    details_str = "\n".join(details)

    admin_text = (
        f"üîî <b>–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ #{order_number}</b>\n"
        f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"{details_str}\n\n"
    )

    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
    admin_keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"confirm_order_{order_id}_{user_id}"),
                InlineKeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"reject_order_{order_id}_{user_id}")
            ]
        ]
    )

    return admin_text, admin_keyboard



def get_final_confirmation_text_with_topic(order_number: int) -> str:
    """–§–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–∏–∫–µ—Ç–µ."""
    return (
        f"‚úÖ <b>–í–∞—à–∞ –∑–∞—è–≤–∫–∞ #{order_number} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</b>\n\n"
        f"–û–ø–µ—Ä–∞—Ç–æ—Ä —É–∂–µ –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –ø—Ä—è–º–æ –≤ —Ç–µ–º–µ —Å –≤–∞—à–µ–π –∑–∞—è–≤–∫–æ–π.\n\n"
        f"–í—Å—é –¥–∞–ª—å–Ω–µ–π—à—É—é –ø–µ—Ä–µ–ø–∏—Å–∫—É, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ–¥–∏—Ç–µ –≤ —ç—Ç–æ–π —Ç–µ–º–µ."
    )



def get_active_order_notice_text(order_number: int) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞.
    """
    return (
        f"<b>‚ùóÔ∏è –í–Ω–∏–º–∞–Ω–∏–µ</b>\n\n"
        f"–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞ <b>#{order_number}</b>. "
        f"–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é, –ø–æ–∫–∞ —Ç–µ–∫—É—â–∞—è –Ω–µ –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n\n"
        f"–ù–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞—è–≤–∫–µ:"
    )


def get_requisites_and_chat_prompt_text(
    action: str,
    crypto: str,
    total_amount: float,
    sbp_phone: str,
    sbp_bank: str,
    wallet_address: str
) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –°–æ–¥–µ—Ä–∂–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –¥–∏–∞–ª–æ–≥–∞ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º.
    """
    if action == 'buy':
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫—É–ø–∞–µ—Ç –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É ‚Üí –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Ä—É–±–ª–∏
        payment_details = (
            f"üí∞ –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ <b>{total_amount:.0f} RUB</b> –ø–æ —Å–ª–µ–¥—É—é—â–∏–º —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º:\n\n"
            f"üìû –¢–µ–ª–µ—Ñ–æ–Ω (–°–ë–ü): <code>{sbp_phone}</code>\n"
            f"üè¶ –ë–∞–Ω–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è: <b>{sbp_bank}</b>"
        )
        instruction = "–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ <b>—Å–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ —á–µ–∫ –æ–± –æ–ø–ª–∞—Ç–µ</b> –ø—Ä—è–º–æ –≤ —ç—Ç–æ—Ç —á–∞—Ç."

    else:  # sell
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–¥–∞–µ—Ç –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É ‚Üí –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –Ω–∞ –∫–æ—à–µ–ª–µ–∫
        payment_details = (
            f"üí∞ –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—É –Ω–∞ –Ω–∞—à –∫–æ—à–µ–ª–µ–∫:\n\n"
            f"<b>{crypto.upper()} –ê–¥—Ä–µ—Å:</b>\n<code>{wallet_address}</code>"
        )
        instruction = (
            "–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ <b>ID –∏–ª–∏ —Ö—ç—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</b>, –∞ —Ç–∞–∫–∂–µ "
            "<b>–≤–∞—à–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä—É–±–ª–µ–π</b> (–Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã/–°–ë–ü –∏ –±–∞–Ω–∫)."
        )

    return (
        f"‚úÖ <b>–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!</b>\n\n"
        f"{payment_details}\n\n"
        f"‚ö†Ô∏è <b>–í–∞–∂–Ω–æ:</b> {instruction}\n\n"
        f"üë®‚Äçüíº <b>–ù–∞—á–∞—Ç –¥–∏–∞–ª–æ–≥ —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º.</b>\n"
        f"‚úâÔ∏è –í—Å–µ –≤–∞—à–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—ã–ª–∞—é—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä—É, "
        f"–∏ –µ–≥–æ –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Å—é–¥–∞."
    )



def get_profile_text(
    user_id: int,
    profile_data: dict,
    bot_username: str,
    ref_info: dict,
    ref_percentage: float
) -> str:
    """–û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–æ—Ñ–∏–ª—è –∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã."""

    # --- –ü—Ä–æ—Ñ–∏–ª—å ---
    if profile_data:
        username = profile_data['username'] or "–Ω–µ —É–∫–∞–∑–∞–Ω"
        profile_block = (
            "<b>üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</b>\n\n"
            f"<b>ID:</b> <code>{user_id}</code>\n"
            f"<b>–ù–∏–∫–Ω–µ–π–º:</b> @{username}\n\n"
            "<b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω—ã—Ö –æ–±–º–µ–Ω–æ–≤:</b>\n"
            f"  ‚Ä¢ <b>–í—Å–µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:</b> {profile_data['total_orders']}\n"
            f"  ‚Ä¢ <b>–û–±—â–∏–π –æ–±—ä—ë–º:</b> {profile_data['total_volume_rub']:.2f} RUB"
        )
    else:
        profile_block = (
            "<b>üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</b>\n\n"
            "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ. –í–æ–∑–º–æ–∂–Ω–æ, —É –≤–∞—Å –µ—â—ë –Ω–µ –±—ã–ª–æ —É—Å–ø–µ—à–Ω—ã—Ö –æ–±–º–µ–Ω–æ–≤."
        )

    # --- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ ---
    referral_link = f"https://t.me/{bot_username}?start=ref{user_id}"
    balance = ref_info.get('balance', 0.0)
    referral_count = ref_info.get('referral_count', 0)

    referral_block = (
        "\n\n<b>üë• –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>\n\n"
        f"–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ <b>{ref_percentage:.1f}%</b> "
        "—Å —Å—É–º–º—ã –∫–∞–∂–¥–æ–≥–æ –∏—Ö —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–º–µ–Ω–∞!\n\n"
        "üîó <b>–í–∞—à–∞ —É–Ω–∏–∫–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</b>\n"
        f"<code>{referral_link}</code>\n"
        "<i>(–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å)</i>\n\n"
        "üìà <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"
        f"  ‚Ä¢ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <b>{referral_count}</b>\n"
        f"  ‚Ä¢ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <b>{balance:,.2f} RUB</b>\n\n"
        "–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏, –∫–æ–≥–¥–∞ –±–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã."
    )

    return [profile_block + referral_block, balance]






def get_withdrawal_prompt_text(min_amount: int, balance: float) -> str:
    """–¢–µ–∫—Å—Ç —Å –∑–∞–ø—Ä–æ—Å–æ–º —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤."""
    return (
        "üí∞ <b>–í—ã–≤–æ–¥ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞</b>\n\n"
        f"–í–∞—à –±–∞–ª–∞–Ω—Å: <b>{balance:,.2f} RUB</b>.\n"
        f"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞: <b>{min_amount} RUB</b>.\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ "
        "(–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞).\n\n"
        "<b>–ü—Ä–∏–º–µ—Ä:</b> <code>5555 4444 3333 2222, –°–±–µ—Ä–±–∞–Ω–∫</code>"
    )


def get_withdrawal_request_admin_notification(user_id: int, username: str, amount: float) -> str:
    """–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –æ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–µ –Ω–∞ –≤—ã–≤–æ–¥."""
    return (
        "üí∏ <b>–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤</b>\n"
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
        f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {format_user_display_name(username)} (<code>{user_id}</code>)\n"
        f"üí∞ <b>–°—É–º–º–∞:</b> <code>{amount:,.2f} RUB</code>\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–ø–ª–∞—Ç—ã."
    )


def get_referral_earnings_text(earnings: List[Tuple], balance: float) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –≤ –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ."""
    if not earnings:
        return (
            "üìà <b>–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</b>\n\n"
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π.\n\n"
            "–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ, –∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏—Ö —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–º–µ–Ω–∞ –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ!"
        )

    header = (
        f"üìà <b>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</b>\n"
        f"üí∞ –í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <b>{balance:,.2f} RUB</b>\n\n"
    )

    history_lines = []
    for amount, created_at_str in earnings:
        created_at_dt = datetime.fromisoformat(created_at_str)
        formatted_date = created_at_dt.strftime('%d.%m.%Y %H:%M')
        history_lines.append(f"<code>+{amount:,.2f} RUB</code>   <i>{formatted_date}</i>")

    body = "\n".join(history_lines)

    return f"{header}{body}"

